<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Minting Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .running { background-color: #10b981; }
        .stopped { background-color: #ef4444; }
        .dot {
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        #walletModeToggle:checked ~ .block {
            background-color: #10b981;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">üé® NFT Minting Bot</h1>
            <p class="text-gray-400">Avalanche Network - Early Puppeteer NFTs</p>
        </div>

        <!-- Bot Status Card -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span id="statusDot" class="status-dot stopped"></span>
                    <span class="text-2xl font-semibold">Bot Status: <span id="botStatus">Checking...</span></span>
                </div>
                <div class="space-x-4">
                    <button onclick="startBot()" id="startBtn" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition">
                        ‚ñ∂ Start Bot
                    </button>
                    <button onclick="stopBot()" id="stopBtn" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-semibold transition">
                        ‚è∏ Stop Bot
                    </button>
                    <button onclick="refreshDashboard()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Wallet Scraper Card -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
            <h2 class="text-2xl font-bold mb-4">üîç Wallet Scraper</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Scraper Controls -->
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <span id="scraperStatusDot" class="status-dot stopped"></span>
                            <span class="text-lg font-semibold">Status: <span id="scraperStatus">Stopped</span></span>
                        </div>
                        <div class="space-x-2">
                            <button onclick="startScraper()" id="startScraperBtn" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition text-sm">
                                ‚ñ∂ Start Scraper
                            </button>
                            <button onclick="stopScraper()" id="stopScraperBtn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold transition text-sm">
                                ‚è∏ Stop Scraper
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-700 rounded p-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Wallets Collected:</span>
                            <span class="font-bold" id="scraperWalletsCollected">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Target:</span>
                            <span class="font-bold" id="scraperTarget">4000</span>
                        </div>
                        <div class="text-sm text-gray-400 mt-2" id="scraperMessage"></div>
                    </div>
                </div>
                
                <!-- Wallet Mode Toggle -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">Wallet Source Mode</h3>
                    <div class="bg-gray-700 rounded p-4">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-gray-300">Current Mode:</span>
                            <span class="font-bold text-lg" id="walletModeDisplay">Generate</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center cursor-pointer">
                                <span class="mr-3 text-gray-300">Generate</span>
                                <div class="relative">
                                    <input type="checkbox" id="walletModeToggle" class="sr-only" onchange="toggleWalletMode()">
                                    <div class="block bg-gray-600 w-14 h-8 rounded-full" id="walletModeTrack"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition transform" id="walletModeDot"></div>
                                </div>
                                <span class="ml-3 text-gray-300">Scraped</span>
                            </label>
                        </div>
                        <div class="mt-4 bg-gray-600 rounded p-3">
                            <div class="text-sm text-gray-300 mb-2">Scraped Wallet Statistics:</div>
                            <div class="grid grid-cols-3 gap-2 text-xs">
                                <div>
                                    <div class="text-gray-400">Total</div>
                                    <div class="font-bold" id="scrapedTotal">0</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Available</div>
                                    <div class="font-bold text-green-400" id="scrapedAvailable">0</div>
                                </div>
                                <div>
                                    <div class="text-gray-400">Used</div>
                                    <div class="font-bold text-yellow-400" id="scrapedUsed">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <div class="text-gray-400 text-sm mb-1">Total Minted</div>
                <div class="text-3xl font-bold text-blue-400" id="totalMinted">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <div class="text-gray-400 text-sm mb-1">Mainnet</div>
                <div class="text-3xl font-bold text-purple-400" id="mainnetCount">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <div class="text-gray-400 text-sm mb-1">Testnet</div>
                <div class="text-3xl font-bold text-yellow-400" id="testnetCount">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <div class="text-gray-400 text-sm mb-1">Success</div>
                <div class="text-3xl font-bold text-green-400" id="successCount">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <div class="text-gray-400 text-sm mb-1">Failed</div>
                <div class="text-3xl font-bold text-red-400" id="failedCount">0</div>
            </div>
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <div class="text-gray-400 text-sm mb-1">Today</div>
                <div class="text-3xl font-bold text-cyan-400" id="todayCount">0</div>
            </div>
        </div>

        <!-- Wallet Balances -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
            <h2 class="text-2xl font-bold mb-4">üí∞ Wallet Balances</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <div class="text-gray-400 text-sm mb-1">Owner Address</div>
                    <div class="font-mono text-sm bg-gray-700 p-2 rounded" id="ownerAddress">Loading...</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Testnet Balance</div>
                    <div class="text-xl font-bold" id="testnetBalance">- AVAX</div>
                </div>
                <div>
                    <div class="text-gray-400 text-sm mb-1">Mainnet Balance</div>
                    <div class="text-xl font-bold" id="mainnetBalance">- AVAX</div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
            <h2 class="text-2xl font-bold mb-4">üì§ Export Data</h2>
            <div class="flex space-x-4">
                <button onclick="downloadCSV()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition">
                    üíæ Download CSV
                </button>
                <button onclick="emailCSV()" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-semibold transition">
                    üìß Email CSV
                </button>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 shadow-lg">
            <h2 class="text-2xl font-bold mb-4">üìú Recent Transactions</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left p-2">Time</th>
                            <th class="text-left p-2">Network</th>
                            <th class="text-left p-2">Recipient</th>
                            <th class="text-left p-2">Status</th>
                            <th class="text-left p-2">Explorer</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        <tr>
                            <td colspan="5" class="text-center p-4 text-gray-400">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Bot Logs -->
        <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
            <h2 class="text-2xl font-bold mb-4">üìã Bot Logs (Last 50 lines)</h2>
            <div class="bg-gray-900 rounded p-4 font-mono text-xs overflow-auto max-h-96">
                <div id="logsContainer">Loading logs...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://44.200.14.34:5000/api';

        async function checkBotStatus() {
            try {
                const response = await fetch(`${API_URL}/bot/status`);
                const data = await response.json();
                
                const statusDot = document.getElementById('statusDot');
                const botStatus = document.getElementById('botStatus');
                
                if (data.running) {
                    statusDot.className = 'status-dot running';
                    botStatus.textContent = `Running (PID: ${data.pid})`;
                } else {
                    statusDot.className = 'status-dot stopped';
                    botStatus.textContent = 'Stopped';
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        async function startBot() {
            if (!confirm('Start the minting bot?')) return;
            
            try {
                const response = await fetch(`${API_URL}/bot/start`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Bot started successfully!');
                    refreshDashboard();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to start bot: ' + error.message);
            }
        }

        async function stopBot() {
            if (!confirm('Stop the minting bot?')) return;
            
            try {
                const response = await fetch(`${API_URL}/bot/stop`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('Bot stopped successfully!');
                    refreshDashboard();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to stop bot: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                const data = await response.json();
                
                document.getElementById('totalMinted').textContent = data.total_minted;
                document.getElementById('mainnetCount').textContent = data.mainnet_count;
                document.getElementById('testnetCount').textContent = data.testnet_count;
                document.getElementById('successCount').textContent = data.success_count;
                document.getElementById('failedCount').textContent = data.failed_count;
                document.getElementById('todayCount').textContent = data.today_count;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadBalances() {
            try {
                const response = await fetch(`${API_URL}/aws/balance`);
                const data = await response.json();
                
                if (!data.error) {
                    document.getElementById('ownerAddress').textContent = data.owner_address;
                    document.getElementById('testnetBalance').textContent = parseFloat(data.testnet_balance).toFixed(4) + ' AVAX';
                    document.getElementById('mainnetBalance').textContent = parseFloat(data.mainnet_balance).toFixed(4) + ' AVAX';
                }
            } catch (error) {
                console.error('Error loading balances:', error);
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch(`${API_URL}/transactions?limit=20`);
                const data = await response.json();
                
                const tbody = document.getElementById('transactionsTable');
                tbody.innerHTML = '';
                
                if (data.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-400">No transactions yet</td></tr>';
                    return;
                }
                
                data.transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-750';
                    
                    const time = new Date(tx.Timestamp).toLocaleString();
                    const statusColor = tx.Status === 'SUCCESS' ? 'text-green-400' : 'text-red-400';
                    
                    row.innerHTML = `
                        <td class="p-2">${time}</td>
                        <td class="p-2"><span class="px-2 py-1 rounded ${tx.Network === 'mainnet' ? 'bg-purple-600' : 'bg-yellow-600'}">${tx.Network}</span></td>
                        <td class="p-2 font-mono text-xs">${tx.Recipient_Address.slice(0, 10)}...${tx.Recipient_Address.slice(-8)}</td>
                        <td class="p-2 ${statusColor} font-semibold">${tx.Status}</td>
                        <td class="p-2">
                            ${tx.Explorer_URL !== 'N/A' ? `<a href="${tx.Explorer_URL}" target="_blank" class="text-blue-400 hover:underline">View ‚Üó</a>` : '-'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        async function loadLogs() {
            try {
                const response = await fetch(`${API_URL}/logs?lines=50`);
                const data = await response.json();
                
                const logsContainer = document.getElementById('logsContainer');
                
                if (data.logs.length === 0) {
                    logsContainer.textContent = 'No logs available';
                    return;
                }
                
                logsContainer.innerHTML = data.logs.map(log => 
                    `<div class="mb-1">${escapeHtml(log)}</div>`
                ).join('');
                
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        async function downloadCSV() {
            try {
                window.open(`${API_URL}/export/csv`, '_blank');
            } catch (error) {
                alert('Failed to download CSV: ' + error.message);
            }
        }

        async function emailCSV() {
            const email = prompt('Enter email address (or leave blank for default):');
            
            try {
                const response = await fetch(`${API_URL}/export/email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email || undefined })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('CSV emailed successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to email CSV: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Scraper Functions
        async function checkScraperStatus() {
            try {
                const response = await fetch(`${API_URL}/scraper/status`);
                const data = await response.json();
                
                const statusDot = document.getElementById('scraperStatusDot');
                const statusText = document.getElementById('scraperStatus');
                const startBtn = document.getElementById('startScraperBtn');
                const stopBtn = document.getElementById('stopScraperBtn');
                
                if (data.running) {
                    statusDot.className = 'status-dot running';
                    statusText.textContent = 'Running';
                    startBtn.disabled = true;
                    startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    stopBtn.disabled = false;
                    stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    statusDot.className = 'status-dot stopped';
                    statusText.textContent = data.status === 'completed' ? 'Completed' : 'Stopped';
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    stopBtn.disabled = true;
                    stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                document.getElementById('scraperWalletsCollected').textContent = data.wallets_collected || 0;
                document.getElementById('scraperTarget').textContent = data.target || 4000;
                document.getElementById('scraperMessage').textContent = data.message || '';
            } catch (error) {
                console.error('Error checking scraper status:', error);
            }
        }

        async function loadScraperStats() {
            try {
                const response = await fetch(`${API_URL}/scraper/stats`);
                const data = await response.json();
                
                document.getElementById('scrapedTotal').textContent = data.total_wallets || 0;
                document.getElementById('scrapedAvailable').textContent = data.available_wallets || 0;
                document.getElementById('scrapedUsed').textContent = data.used_wallets || 0;
            } catch (error) {
                console.error('Error loading scraper stats:', error);
            }
        }

        async function loadWalletMode() {
            try {
                const response = await fetch(`${API_URL}/wallet-mode`);
                const data = await response.json();
                
                const mode = data.mode || 'generate';
                const toggle = document.getElementById('walletModeToggle');
                const dot = document.getElementById('walletModeDot');
                const display = document.getElementById('walletModeDisplay');
                
                const track = document.getElementById('walletModeTrack');
                if (mode === 'scraped') {
                    toggle.checked = true;
                    dot.style.transform = 'translateX(24px)';
                    dot.classList.add('bg-green-500');
                    if (track) track.style.backgroundColor = '#10b981';
                    display.textContent = 'Scraped';
                } else {
                    toggle.checked = false;
                    dot.style.transform = 'translateX(0)';
                    dot.classList.remove('bg-green-500');
                    if (track) track.style.backgroundColor = '#4b5563';
                    display.textContent = 'Generate';
                }
            } catch (error) {
                console.error('Error loading wallet mode:', error);
            }
        }

        async function startScraper() {
            try {
                const response = await fetch(`${API_URL}/scraper/start`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Scraper started successfully!');
                    checkScraperStatus();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to start scraper: ' + error.message);
            }
        }

        async function stopScraper() {
            if (!confirm('Are you sure you want to stop the scraper?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/scraper/stop`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Scraper stopped successfully!');
                    checkScraperStatus();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to stop scraper: ' + error.message);
            }
        }

        async function toggleWalletMode() {
            const toggle = document.getElementById('walletModeToggle');
            const dot = document.getElementById('walletModeDot');
            const track = document.getElementById('walletModeTrack');
            const mode = toggle.checked ? 'scraped' : 'generate';
            
            // Update UI immediately for better UX
            if (mode === 'scraped') {
                dot.style.transform = 'translateX(24px)';
                dot.classList.add('bg-green-500');
                if (track) track.style.backgroundColor = '#10b981';
            } else {
                dot.style.transform = 'translateX(0)';
                dot.classList.remove('bg-green-500');
                if (track) track.style.backgroundColor = '#4b5563';
            }
            
            try {
                const response = await fetch(`${API_URL}/wallet-mode`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });
                const data = await response.json();
                
                if (data.success) {
                    loadWalletMode(); // Reload to sync with server
                    alert(`Wallet mode set to: ${mode}`);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    toggle.checked = !toggle.checked;
                    loadWalletMode(); // Revert UI
                }
            } catch (error) {
                alert('Failed to set wallet mode: ' + error.message);
                toggle.checked = !toggle.checked;
                loadWalletMode(); // Revert UI
            }
        }

        function refreshDashboard() {
            checkBotStatus();
            loadStats();
            loadBalances();
            loadTransactions();
            loadLogs();
            checkScraperStatus();
            loadScraperStats();
            loadWalletMode();
        }

        // Initial load
        refreshDashboard();

        // Auto-refresh every 10 seconds
        setInterval(refreshDashboard, 10000);
    </script>
</body>
</html>

